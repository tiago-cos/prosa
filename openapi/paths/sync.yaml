get:
  tags:
    - Sync
  summary: "Sync device"
  description: |
    Returns a list of book and shelf IDs belonging to a given user that have changed since the last sync token.

    **Synchronization Logic:**
    - This endpoint uses a **sync token** (an integer sequence number) to ensure robust synchronization.
    - **Session Awareness:** 
      - Each login or registration creates a unique, persistent **Session ID**.
      - This Session ID is embedded in the JWT and persists across token refreshes.
      - Changes made by the *current* session are excluded from the response to prevent "echoing" changes back to the device that made them.
      - If you log out and log back in, a new Session ID is generated, and that new session will need to perform a full sync.
      - API Key authentication is treated as a distinct session.

    **Book categories:**
    - `file`: Newly added books.  
    - `metadata`: Books with updated metadata.  
    - `cover`: Books with updated covers.  
    - `state`: Books with updated state.  
    - `annotations`: Books with updated annotations.
    - `deleted`: Books that have been removed.

    **Shelf categories:**
    - `metadata`: Shelves with updated metadata.  
    - `contents`: Shelves with updated contents.  
    - `deleted`: Shelves that have been removed.

    **Note:** If `user_id` is not provided, the user will be inferred from the authentication token.  
    **Another note:** Only admin users are allowed to retrieve sync information for other users.

  operationId: sync
  parameters:
    - name: user_id
      in: query
      description: _(Optional)_ User ID for sync. If not provided, it will be extracted from the authentication process.
      required: false
      schema:
        type: string
        format: uuid
        example: d98354c3-376a-4bb3-9aa6-53583f89cf5e

    - name: sync_token
      in: query
      description: _(Optional)_ The last known sync token (integer sequence number). If empty or 0, a full sync (all current items) is returned.
      required: false
      schema:
        type: integer
        format: int64
        example: 15023

  responses:
    "200":
      description: The changes that occurred after the provided sync token.
      content:
        application/json:
          schema:
            $ref: ../components/schemas/Sync.yaml
    "400":
      $ref: ../components/responses/sync/InvalidSyncToken.yaml
    "401":
      $ref: ../components/responses/Unauthorized.yaml
    "403":
      $ref: ../components/responses/Forbidden.yaml
    "404":
      $ref: ../components/responses/users/UserNotFound.yaml

  security:
    - prosaToken: []
    - apiKey: []
